# 技术方案（TECH-REFER）

## 架构图描述
- 输入：CSV（文本/说话人/参考音频/参考文本） + 参考音频文件
- 处理：文本清洗 → 参考音频加载/裁剪 → 音色签名提取 → 推理生成
- 输出：单条语音文件 + 合并语音文件

## 模块关系
- `examples/cmd/run_csv_batch.py`：批量入口与流程控制
- `examples/cmd/csv_batch_utils.py`：通用工具（读取/保存/清洗/兜底）
- `examples/cmd/run_config.py`：单条生成入口（参数试验）
- `tools/audio/av.py`：音频加载与重采样

## 数据结构
- CSV 行字段：
  - `文本`：目标生成文本
  - `说话人`：固定音色或随机
  - `参考音频`：参考音频文件名
  - `参考文本`：与参考音频逐字对齐的转写
- 推理参数对象：
  - `InferCodeParams.spk_smp`：参考音频的音色签名
  - `InferCodeParams.txt_smp`：参考文本（前缀提示）

## 调用链路
1. 读取 CSV → 校验字段
2. 读取参考音频 → 可选裁剪静音 → 提取 `spk_smp`
3. 组装推理参数 → 调用 `ChatTTS.Chat.infer`
4. 保存单条音频 → 合并输出

## 算法设计
- 参考音频清洗：静音阈值裁剪 + 峰值归一化
- 空音频兜底：检测近静音后重试（提高采样参数）
- 文本拆分：`ChatTTS` 默认会分句；如果参考文本拼在前面，会表现为“续写后半段”

## 性能边界
- CPU 模式可运行，但耗时较高
- 参考音频建议 5~15 秒、单人、背景噪声低
- 参考文本必须与参考音频逐字对齐，否则音色稳定性下降

## 抽象层级划分
- 业务层：CSV 批量流程（run_csv_batch.py）
- 工具层：音频/文本/兜底工具（csv_batch_utils.py）
- 模型层：ChatTTS 推理与参数对象
